<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width, initial-scale=1.0'>
<link rel='stylesheet' href='https://static.zly.vg/sample/style.css'>
<link rel='stylesheet' href='./common.css'>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<title>Document</title>
<style>
.bin{
    border: 1px solid #ccc;
    border-radius: 5.43px;
    padding: 10px;  
    margin: .5rem 0;
}

.binId{
    font-weight: bold;
    font-size: x-small;
}

.bin.selected{
    border-width: 2px;
    border-color: green;
}

#bins:empty::before{
    content: 'No bins yet';
    color: #ccc;
    font-style: italic;
    font-size: small;
    text-align: center;
    display: block;
    margin-top: 15dvh;
}

#selected_bins_num::after{
    content: '/';
}

</style>
</head>
<body>
<h1>OurBin<sup ondblclick="hd.toggleAttribute('hidden')"><small>v</small><small id='version'>1.0.1</small></sup></h1>
<h2>New</h2>
</div>
<div id="new">
    <textarea name="" id="new" rows="5" placeholder="Your pasta here..."></textarea><br>
    <div class="button_group">
        <button data-icon="content_paste_go" onclick="importFromClipboard()">Import from clipboard</button>
        <!-- <span style="margin-left: auto;">Expiration:</span> -->
        <select name="" id="expiration" style="margin-left: auto;">
            <option disabled>Expiration:</option>
            <option value="1">1m</option>
            <option value="5">5m</option>
            <option value="10">10m</option>
            <option value="30">30m</option>
            <option value="60">1h</option>
            <option value="120">2h</option>
            <option value="240">4h</option>
            <option value="480">8h</option>
            <option value="1440" selected>1d</option>
            <option value="2880">2d</option>
            <option value="10080">1w</option>
            <option value="-1">never</option>
        </select>
        <button data-icon="order_approve">Submit</button>
    </div>

    <!-- <div id="upload" style="border: 2px dashed #bbb; border-radius: 5.43px; padding: 10vh;">
        <label for="file_input">Or upload a file:</label>
        <input type="file" id="file_input" name="file_input">
    </div> -->
</div>
<h2>Existing (<span id="selected_bins_num" hidden>0</span><span id="total_bins_count">0</span>)</h2>
<div id="sort">
    <!-- <button data-icon="more_timearrow_upward" onclick="sortByCreationTime()">Sort by creation time</button>
    <button data-icon="search_activityarrow_upward" onclick="sortByExpirationTime()">Sort by expiration time</button>
    <button data-icon="expansion_panelsarrow_upward" onclick="sortByExpirationTime()">Sort by content length</button> -->
    Sort by <select name="" id="sort_by">
        <option value="creation_time" selected>Creation time</option>
        <option value="expiration_time">Expiration time</option>
    </select>
    <select name="" id="sort_order">
        <option value="desc" selected>Descending</option>
        <option value="asc">Ascending</option>
    </select>
</div>
<div class="button_group">
    <button data-icon="cached" onclick="refresh()">Refresh</button>
    <button data-icon="control_point_duplicate" id="select">Select all</button>
    <button class="disabled" id="renew" style="margin-left: auto;" data-icon="event_repeat" title="renew for 1 day">+1d</button>
    <button class="disabled red" id="delete" data-icon="delete">Void</button>
</div>
<div id="bins"></div>

<div id="hd" hidden>
    <h2>Danger zone</h2>
    <button data-icon="delete_forever" onclick="clearBins()" class="red">Clean up</button>
    <button data-icon="reset_wrench" onclick="resetDB()" class="red">Reset</button>
</div>

<script>
const API_BASE = 'http://localhost:8000/api';

const importFromClipboard = async function (selector='textarea#new') {
try {
    const text = await navigator.clipboard.readText();
    document.querySelector(selector).value = text;
} catch (err) {
    console.error('读取剪贴板失败：', err);
    alert('无法读取剪贴板内容，请确保在 HTTPS 页面上，并允许访问剪贴板。');
}
};

// 获取版本号
async function loadVersion() {
    try {
        const res = await fetch(`${API_BASE}/health`);
        const data = await res.json();
        document.getElementById('version').textContent = data.version;
    } catch (err) {
        console.error('获取版本号失败：', err);
    }
}

// 转义HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// 格式化时间剩余
function formatTimeLeft(expirationTime) {
    const now = Math.floor(Date.now() / 1000);
    const left = expirationTime - now;
    const hours = left / 3600;
    const days = left / (24 * 3600);
    // 如果大于1年（365天），显示 "--"
    if (days > 365) return '--';
    if (hours < 1) return '<1h';
    if (hours > 24) return '>24h';
    return `${Math.floor(hours)}h`;
}

// 刷新列表
async function refresh() {
    try {
        const sortBy = document.getElementById('sort_by').value;
        const sortOrder = document.getElementById('sort_order').value;
        const res = await fetch(`${API_BASE}/bins?sort_by=${sortBy}&order=${sortOrder}`);
        const bins = await res.json();
        document.getElementById('total_bins_count').textContent = bins.length;
        const binsContainer = document.getElementById('bins');
        binsContainer.innerHTML = '';
        
        bins.forEach(bin => {
            const binDiv = document.createElement('div');
            binDiv.className = 'bin';
            binDiv.dataset.id = bin.uuid;
            
            const timeLeft = formatTimeLeft(bin.expiration_time);
            
            binDiv.innerHTML = `
                <div style="display: flex;">
                    <input type="checkbox" onchange="toggleSelect('${bin.uuid}')">
                    <a class="binId" href="./bin.html?id=${bin.uuid}">${bin.uuid}</a>
                    <span class="icon" style="font-size: small; margin-left: auto;" data-icon="search_activity">${timeLeft}</span>
                </div>
                <div class="binPreview" style="padding: .5rem 0">${escapeHtml(bin.preview)}</div>
                <div class="button_group">
                    <button data-icon="copy_all" onclick="copyBinContent('${bin.uuid}')">Copy all</button>
                    <button data-icon="delete" class="red" onclick="deleteBin('${bin.uuid}')">Void</button>
                </div>
            `;
            binsContainer.appendChild(binDiv);
        });
        // 刷新后重置选中数量为0
        updateButtonStates();
    } catch (err) {
        console.error('刷新失败：', err);
    }
}

// 选择/取消选择
function toggleSelect(uuid) {
    const bin = document.querySelector(`.bin[data-id="${uuid}"]`);
    const checkbox = bin.querySelector('input[type="checkbox"]');
    if (checkbox.checked) {
        bin.classList.add('selected');
    } else {
        bin.classList.remove('selected');
    }
    updateButtonStates();
}

// 更新按钮状态和选中数量
function updateButtonStates() {
    const selected = document.querySelectorAll('.bin.selected');
    const renewBtn = document.getElementById('renew');
    const deleteBtn = document.getElementById('delete');
    const selectedNum = document.getElementById('selected_bins_num');
    
    // 更新选中数量
    selectedNum.textContent = selected.length;
    
    // 根据是否有选中来控制显示/隐藏
    if (selected.length > 0) {
        selectedNum.toggleAttribute('hidden', false);
        renewBtn.classList.remove('disabled');
        deleteBtn.classList.remove('disabled');
    } else {
        selectedNum.toggleAttribute('hidden', true);
        renewBtn.classList.add('disabled');
        deleteBtn.classList.add('disabled');
    }
}

// 全选/取消全选
document.getElementById('select').onclick = function() {
    const isSelectAll = this.textContent.includes('Select all');
    const checkboxes = document.querySelectorAll('.bin input[type="checkbox"]');
    checkboxes.forEach(cb => {
        cb.checked = isSelectAll;
        const bin = cb.closest('.bin');
        if (isSelectAll) {
            bin.classList.add('selected');
        } else {
            bin.classList.remove('selected');
        }
    });
    this.textContent = isSelectAll ? 'Deselect' : 'Select all';
    updateButtonStates();
};

// 删除bin
async function deleteBin(uuid) {
    if (!confirm('确定要删除这个bin吗？')) return;
    try {
        const res = await fetch(`${API_BASE}/bins/${uuid}`, { method: 'DELETE' });
        if (res.ok) {
            refresh();
        } else {
            alert('删除失败');
        }
    } catch (err) {
        console.error('删除失败：', err);
        alert('删除失败：' + err.message);
    }
}

// 批量删除
document.getElementById('delete').onclick = async function() {
    const selected = document.querySelectorAll('.bin.selected');
    if (selected.length === 0) return;
    if (!confirm(`确定要删除 ${selected.length} 个bin吗？`)) return;
    
    const uuids = Array.from(selected).map(bin => bin.dataset.id);
    try {
        const res = await fetch(`${API_BASE}/bins/${uuids.join(',')}`, { method: 'DELETE' });
        if (res.ok) {
            refresh();
        } else {
            alert('删除失败');
        }
    } catch (err) {
        console.error('删除失败：', err);
        alert('删除失败：' + err.message);
    }
};

// 复制bin内容
async function copyBinContent(uuid) {
    try {
        const res = await fetch(`${API_BASE}/bins/${uuid}`);
        const bin = await res.json();
        await navigator.clipboard.writeText(bin.content);
        alert('已复制到剪贴板');
    } catch (err) {
        console.error('复制失败：', err);
        alert('复制失败：' + err.message);
    }
}

// 提交新bin
document.querySelector('button[data-icon="order_approve"]').onclick = async function() {
    const textarea = document.querySelector('textarea#new');
    const content = textarea.value.trim();
    if (!content) {
        alert('请输入内容');
        return;
    }
    
    const expiration = document.getElementById('expiration').value;
    // 选项值都是分钟，需要转换为小时
    const expirationHours = expiration === '-1' ? 999999 : parseInt(expiration) / 60;
    
    try {
        const res = await fetch(`${API_BASE}/bins`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content, expiration_hours: expirationHours })
        });
        if (res.ok) {
            textarea.value = '';
            refresh();
        } else {
            alert('创建失败');
        }
    } catch (err) {
        console.error('创建失败：', err);
        alert('创建失败：' + err.message);
    }
};

// 续期功能（+1h）
document.getElementById('renew').onclick = async function() {
    const selected = document.querySelectorAll('.bin.selected');
    if (selected.length === 0) return;
    
    const uuids = Array.from(selected).map(bin => bin.dataset.id);
    try {
        const res = await fetch(`${API_BASE}/bins/renew`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ uuids })
        });
        if (res.ok) {
            const data = await res.json();
            alert(`成功续期 ${data.updated_count} 个bin`);
            refresh();
        } else {
            const error = await res.json();
            alert('续期失败：' + (error.detail || '未知错误'));
        }
    } catch (err) {
        console.error('续期失败：', err);
        alert('续期失败：' + err.message);
    }
};

// 清理已过期的bin
async function clearBins() {
    if (!confirm('确定要清理所有已过期的bin吗？')) return;
    
    try {
        const res = await fetch(`${API_BASE}/bins/cleanup`, { method: 'DELETE' });
        if (res.ok) {
            const data = await res.json();
            alert(`清理完成，删除了 ${data.deleted_count} 个已过期的bin`);
            refresh();
        } else {
            alert('清理失败');
        }
    } catch (err) {
        console.error('清理失败：', err);
        alert('清理失败：' + err.message);
    }
}

// 重置数据库
async function resetDB() {
    // 生成6位确认ID
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz123456789';
    let confirmId = '';
    for (let i = 0; i < 6; i++) {
        confirmId += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    
    const userInput = prompt(`警告：此操作将删除所有数据！\n请输入6位确认ID: ${confirmId}`);
    
    if (userInput === null) {
        return; // 用户取消
    }
    
    if (userInput !== confirmId) {
        alert('确认ID不匹配，操作已取消');
        return;
    }
    
    try {
        const res = await fetch(`${API_BASE}/bins/reset`, { method: 'DELETE' });
        if (res.ok) {
            const data = await res.json();
            alert(`数据库已重置，删除了 ${data.deleted_count} 条记录`);
            refresh();
        } else {
            alert('重置失败');
        }
    } catch (err) {
        console.error('重置失败：', err);
        alert('重置失败：' + err.message);
    }
}

// 排序选择变化时刷新
document.getElementById('sort_by').addEventListener('change', refresh);
document.getElementById('sort_order').addEventListener('change', refresh);

// 页面加载时初始化
window.onload = function() {
    loadVersion();
    refresh();
};
</script>
</body>
</html>